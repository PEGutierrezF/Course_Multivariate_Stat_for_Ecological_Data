---
title: "RDA"
author: "Pablo E. Gutiérrez-Fonseca"
date: "10/27/2021"
output: pdf_document
---


1. Primer paso: cargar las librerias que necesitas.


```{r, warning=FALSE, message=FALSE}

library(BiodiversityR)
library(ggrepel)
library(ggplot2)
library(readxl)
library(ggsci)
library(ggforce)
library(dplyr)

```



2. Segundo paso: cargar los datos.

```{r}

species=read.csv("data/RDA_species.csv", header=T, row.names=NULL, sep=",")
env=read.csv("data/RDA_environmetal.csv", header=T, row.names=NULL, sep=",")

```



3.  Before we can use this explanatory matrix we need to check 
that its rows are in the same order as our response matrix
all.equal(rownames(species), rownames(env))

```{r}

all.equal(rownames(species), rownames(env))

```



4. Remover la columna de sitos.
```{r}
species_1 <- select(species, -site)
env_1 <- select(env, -site)
```



5.  Transformar datos.
Hellinger es una transformacion recomendada por Legendre & Callagher (2001)
en datos de abundancia y con una respuesta lineal

```{r}
species_2 <- decostand(species_1, method = "hellinger")

```



6. # vegan requires that we write out each term if we are not going to 
# convert the factor to a dummy matrix

```{r}
rda_tree_all = vegan::rda(species_2 ~ temperature + pH +
                 oxygen + conductivity + plants, data= env_1, scale=T)
rda_tree_all
```




7. Summary
http://dmcglinn.github.io/quant_methods/lessons/multivariate_models.html

Inertia is another name for variation or variance in this case. 
“Total” refers to total variance
“Constrained” refers to the amount of variance explained by the explanatory variables,
“Unconstrained” refers to the residual variance. 
Constrained + Unconstrained = Total.

An R2 statistic can be derived simply as Constrained / Total.

```{r}
summary(rda_tree_all)

head (summary (rda_tree_all))
```

8. Plots
```{r}
screeplot(rda_tree_all)

```


9. Percentage explained by constrained and unconstrained variables.

```{r}
constrained_eig <- rda_tree_all$CCA$eig/rda_tree_all$tot.chi*100
unconstrained_eig <- rda_tree_all$CA$eig/rda_tree_all$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')

```


9. Ordination plots
```{r}
plot(rda_tree_all, scaling=1, main="Odonata in Urban ponds")
spe.sc <- scores(rda_tree_all, choices=1:2, scaling=1, display="sp")
arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
```

10. Calcular las R

```{r}
(R2 <- RsquareAdj(rda_tree_all)$r.squared)

(R2adj <- RsquareAdj(rda_tree_all)$adj.r.squared)

```


```{r}
set.seed(1)
anova.cca(rda_tree_all, by='axis', step=1000)
```
